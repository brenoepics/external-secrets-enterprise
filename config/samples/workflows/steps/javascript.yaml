apiVersion: workflows.external-secrets.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: javascript-step-template
  annotations:
    workflows.external-secrets.io/description: "Template demonstrating JavaScript step usage"
spec:
  version: v1
  name: "JavaScript Step Workflow"
  parameters:
    - name: environment
      description: "Target environment (production, staging, development)"
      default: "development"
    - name: userConfig
      description: "JSON configuration for user settings"
      default: '{"username":"admin","role":"admin","features":["dashboard","reports","admin"]}'
  jobs:
    javascriptDemo:
      standard:
        steps:
          # Simple string manipulation
          - name: stringManipulation
            javascript:
              script: |
                // Get environment from parameters
                const env = '{{ .global.variables.environment }}';
                
                // Convert to uppercase
                setString('env_uppercase', env.toUpperCase());
                
                // Create a formatted environment string
                setString('env_formatted', `Environment: ${env}`);
                
                // Check if it's production
                setBool('is_production', env === 'production');
            outputs:
              - name: env_uppercase
                type: string
              - name: env_formatted
                type: string
              - name: is_production
                type: bool
          
          # Working with JSON data
          - name: jsonProcessing
            javascript:
              script: |
                // Parse JSON from parameters
                const userConfig = JSON.parse('{{ .global.variables.userConfig }}');
                
                // Extract and transform values
                setString('username', userConfig.username);
                setString('role', userConfig.role);
                
                // Create a features string
                setString('features_list', userConfig.features.join(', '));
                
                // Count features
                setNumber('feature_count', userConfig.features.length);
                
                // Check if user has admin role
                setBool('is_admin', userConfig.role === 'admin');
                
                // Create a modified config
                const enhancedConfig = {
                  ...userConfig,
                  last_login: new Date().toISOString(),
                  environment: '{{ .global.variables.environment }}',
                  is_active: true
                };
                
                // Set the enhanced config
                setMap('enhanced_config', enhancedConfig);
            outputs:
              - name: username
                type: string
              - name: role
                type: string
              - name: features_list
                type: string
              - name: feature_count
                type: number
              - name: is_admin
                type: bool
              - name: enhanced_config
                type: map
          
          # Date and time manipulation
          - name: dateTimeManipulation
            javascript:
              script: |
                // Get current date and time
                const now = new Date();
                
                // Format as ISO string
                setString('current_time_iso', now.toISOString());
                
                // Create expiry time (30 days from now)
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 30);
                setString('expiry_date', expiryDate.toISOString());
                
                // Calculate time difference in days
                const diffTime = Math.abs(expiryDate - now);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                setNumber('days_until_expiry', diffDays);
            outputs:
              - name: current_time_iso
                type: string
              - name: expiry_date
                type: string
              - name: days_until_expiry
                type: number
          
          # Conditional logic
          - name: conditionalLogic
            javascript:
              script: |
                // Get values from previous steps
                const isProduction = {{ .global.jobs.javascriptDemo.stringManipulation.is_production }};
                const isAdmin = {{ .global.jobs.javascriptDemo.jsonProcessing.is_admin }};
                const username = '{{ .global.jobs.javascriptDemo.jsonProcessing.username }}';
                
                // Determine access level based on environment and role
                let accessLevel;
                if (isProduction) {
                  accessLevel = isAdmin ? 'full' : 'restricted';
                } else {
                  accessLevel = 'development';
                }
                setString('access_level', accessLevel);
                
                // Create a message based on conditions
                let message;
                if (isProduction && isAdmin) {
                  message = `Warning: ${username} has full production access`;
                } else if (isProduction) {
                  message = `User ${username} has restricted production access`;
                } else {
                  message = `User ${username} has development access`;
                }
                setString('access_message', message);
            outputs:
              - name: access_level
                type: string
              - name: access_message
                type: string
          
          # Debug the results
          - name: debugResults
            debug:
              message: "{{ .global.jobs.javascriptDemo.conditionalLogic.access_message }}"
---
apiVersion: workflows.external-secrets.io/v1alpha1
kind: WorkflowRun
metadata:
  name: javascript-step-run
spec:
  templateRef:
    name: javascript-step-template
  arguments:
    environment: "production"
    userConfig: '{"username":"john.doe","role":"operator","features":["dashboard","reports"]}'